---
// Search component - client-side search functionality
---

<div class="search-container">
  <input
    type="search"
    id="search-input"
    placeholder="Search..."
    aria-label="Search"
  />
  <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="11" cy="11" r="8"></circle>
    <path d="m21 21-4.35-4.35"></path>
  </svg>
  <div id="search-results" class="search-results" style="display: none;"></div>
</div>

<script>
  import Fuse from 'fuse.js';

  // This will be populated with search data
  let fuse: Fuse<any> | null = null;
  let searchData: any[] = [];

  // Fetch search data
  async function initSearch() {
    try {
      const response = await fetch('/search-index.json');
      searchData = await response.json();

      fuse = new Fuse(searchData, {
        keys: ['title', 'content', 'description'],
        threshold: 0.3,
        includeScore: true,
        minMatchCharLength: 2,
      });
    } catch (error) {
      console.error('Failed to load search index:', error);
    }
  }

  // Perform search
  function search(query: string) {
    if (!fuse || !query) {
      return [];
    }
    return fuse.search(query).slice(0, 10);
  }

  // Display results
  function displayResults(results: any[]) {
    const resultsContainer = document.getElementById('search-results');
    if (!resultsContainer) return;

    if (results.length === 0) {
      resultsContainer.style.display = 'none';
      return;
    }

    resultsContainer.innerHTML = results.map(result => {
      const item = result.item;
      return `
        <a href="${item.url}">
          <div class="result-title">${item.title}</div>
          ${item.description ? `<div class="result-excerpt">${item.description}</div>` : ''}
        </a>
      `;
    }).join('');

    resultsContainer.style.display = 'block';
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', () => {
    initSearch();

    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const resultsContainer = document.getElementById('search-results');

    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        const query = (e.target as HTMLInputElement).value;
        if (query.length >= 2) {
          const results = search(query);
          displayResults(results);
        } else {
          if (resultsContainer) {
            resultsContainer.style.display = 'none';
          }
        }
      });

      // Close results when clicking outside
      document.addEventListener('click', (e) => {
        if (resultsContainer && !searchInput.contains(e.target as Node) && !resultsContainer.contains(e.target as Node)) {
          resultsContainer.style.display = 'none';
        }
      });
    }
  });
</script>
